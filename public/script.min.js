function initializeApp(){setDefaultDates(),setupEventListeners(),updateItemRow(0),updatePreview()}function setDefaultDates(){const today=new Date,dueDate=new Date;dueDate.setDate(today.getDate()+30),document.getElementById("invoiceDate").value=formatDate(today),document.getElementById("dueDate").value=formatDate(dueDate),document.getElementById("invoiceNumber").value=generateInvoiceNumber()}function formatDateUS(dateString){if(!dateString)return"";const[year,month,day]=dateString.split("-");return`${month}/${day}/${year}`}function formatDate(date){return`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`}function generateInvoiceNumber(){const now=new Date;return`INV-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}-${Math.floor(1e3*Math.random()).toString().padStart(3,"0")}`}function setupEventListeners(){setupMobileNavigation(),document.getElementById("addItem").addEventListener("click",addItemRow),document.getElementById("resetForm").addEventListener("click",resetForm),document.getElementById("downloadPDF").addEventListener("click",downloadPDF),document.getElementById("logoUpload").addEventListener("change",handleLogoUpload),document.getElementById("invoiceForm").addEventListener("input",function(e){e.target.matches("input, textarea, select")&&updatePreview()}),document.getElementById("taxRate").addEventListener("input",function(){updateTotals(),updatePreview()}),document.getElementById("itemsContainer").addEventListener("input",function(e){if(e.target.matches(".item-name, .item-quantity, .item-price")){const itemRow=e.target.closest(".item-row");updateItemRow(parseInt(itemRow.dataset.index)),updatePreview()}}),document.getElementById("itemsContainer").addEventListener("click",function(e){if(e.target.matches(".remove-item")&&!e.target.disabled){const itemRow=e.target.closest(".item-row");removeItemRow(parseInt(itemRow.dataset.index)),updatePreview()}})}function setupMobileNavigation(){const mobileNavToggle=document.querySelector(".mobile-nav-toggle"),mobileNavClose=document.querySelector(".mobile-nav-close"),mobileNavMenu=document.querySelector(".mobile-nav-menu"),mobileNavOverlay=document.querySelector(".mobile-nav-overlay"),navLinks=document.querySelectorAll(".mobile-nav-menu .nav-link");function closeMobileMenu(){mobileNavMenu&&mobileNavMenu.classList&&mobileNavMenu.classList.remove("active"),mobileNavOverlay&&mobileNavOverlay.classList&&mobileNavOverlay.classList.remove("active"),document.body.style.overflow=""}mobileNavToggle&&mobileNavToggle.addEventListener("click",function(){mobileNavMenu&&mobileNavMenu.classList.toggle("active"),mobileNavOverlay&&mobileNavOverlay.classList.toggle("active");const isActive=mobileNavMenu&&mobileNavMenu.classList&&mobileNavMenu.classList.contains("active");document.body.style.overflow=isActive?"hidden":""}),mobileNavClose&&mobileNavClose.addEventListener("click",closeMobileMenu),mobileNavOverlay&&mobileNavOverlay.addEventListener("click",closeMobileMenu),navLinks.forEach(link=>{link.addEventListener("click",closeMobileMenu)}),window.addEventListener("resize",function(){if(window.innerWidth>768){mobileNavMenu&&mobileNavMenu.classList&&mobileNavMenu.classList.contains("active")&&closeMobileMenu()}}),document.addEventListener("keydown",function(e){const isActive=mobileNavMenu&&mobileNavMenu.classList&&mobileNavMenu.classList.contains("active");"Escape"===e.key&&isActive&&closeMobileMenu()})}function addItemRow(){const itemsContainer=document.getElementById("itemsContainer"),newIndex=itemsContainer.children.length,newItemRow=document.createElement("div");newItemRow.className="item-row fade-in",newItemRow.dataset.index=newIndex,newItemRow.innerHTML='\n        <input type="text" class="item-name" placeholder="description">\n        <input type="number" class="item-quantity" placeholder="Qty" min="1" value="1">\n        <input type="number" class="item-price" placeholder="Price" min="0" step="0.01">\n        <span class="item-total">0.00</span>\n        <button type="button" class="remove-item">Ã—</button>\n    ',itemsContainer.appendChild(newItemRow),updateRemoveButtons(),newItemRow.querySelector(".item-name").focus()}function removeItemRow(index){const itemsContainer=document.getElementById("itemsContainer"),itemRow=itemsContainer.querySelector(`[data-index="${index}"]`);if(itemsContainer.children.length>1){itemRow.remove();itemsContainer.querySelectorAll(".item-row").forEach((row,newIndex)=>{row.dataset.index=newIndex}),updateRemoveButtons(),updateTotals()}}function updateRemoveButtons(){const itemsContainer=document.getElementById("itemsContainer"),removeButtons=itemsContainer.querySelectorAll(".remove-item"),hasMultipleItems=itemsContainer.children.length>1;removeButtons.forEach(button=>{button.disabled=!hasMultipleItems})}function updateItemRow(index){const itemRow=document.querySelector(`[data-index="${index}"]`),total=(parseFloat(itemRow.querySelector(".item-quantity").value)||0)*(parseFloat(itemRow.querySelector(".item-price").value)||0);itemRow.querySelector(".item-total").textContent=formatCurrency(total),updateTotals()}function updateTotals(){const itemRows=document.getElementById("itemsContainer").querySelectorAll(".item-row");let subtotal=0;itemRows.forEach(row=>{const quantity=parseFloat(row.querySelector(".item-quantity").value)||0,price=parseFloat(row.querySelector(".item-price").value)||0;subtotal+=quantity*price});const taxRate=parseFloat(document.getElementById("taxRate").value)||0,taxAmount=subtotal*(taxRate/100),grandTotal=subtotal+taxAmount;return document.getElementById("subtotal").textContent=formatCurrency(subtotal),document.getElementById("taxAmount").textContent=formatCurrency(taxAmount),document.getElementById("grandTotal").textContent=formatCurrency(grandTotal),{subtotal:subtotal,taxAmount:taxAmount,grandTotal:grandTotal,taxRate:taxRate}}function formatCurrency(amount){return new Intl.NumberFormat("en-US",{minimumFractionDigits:2,maximumFractionDigits:2}).format(amount)}function updatePreview(){document.getElementById("previewNumber").textContent=document.getElementById("invoiceNumber").value||"",document.getElementById("previewDate").textContent=formatDateUS(document.getElementById("invoiceDate").value)||"",document.getElementById("previewDueDate").textContent=formatDateUS(document.getElementById("dueDate").value)||"",togglePreviewLine("previewSellerName",document.getElementById("sellerName").value.trim()),togglePreviewLine("previewSellerAddress",document.getElementById("sellerAddress").value.trim()),togglePreviewLine("previewSellerPhone",document.getElementById("sellerPhone").value.trim()),togglePreviewLine("previewSellerTaxId",document.getElementById("sellerTaxId").value.trim()),togglePreviewLine("previewBuyerName",document.getElementById("buyerName").value.trim()),togglePreviewLine("previewBuyerAddress",document.getElementById("buyerAddress").value.trim()),togglePreviewLine("previewBuyerPhone",document.getElementById("buyerPhone").value.trim()),togglePreviewLine("previewBuyerTaxId",document.getElementById("buyerTaxId").value.trim()),updatePreviewItems();const totals=updateTotals(),previewTotalsSection=document.querySelector(".preview-totals");0===totals.subtotal&&0===totals.taxAmount&&0===totals.grandTotal?previewTotalsSection.style.display="none":(previewTotalsSection.style.display="block",document.getElementById("previewSubtotal").textContent=formatCurrency(totals.subtotal),document.getElementById("previewTaxRate").textContent=`${totals.taxRate}%`,document.getElementById("previewTaxAmount").textContent=formatCurrency(totals.taxAmount),document.getElementById("previewGrandTotal").textContent=formatCurrency(totals.grandTotal)),togglePreviewLine("previewNotes",document.getElementById("notes").value.trim())}function togglePreviewLine(elementId,value){const element=document.getElementById(elementId),parentParagraph=element.parentElement;value?(element.textContent=value,parentParagraph.style.display="block"):(element.textContent="",parentParagraph.style.display="none")}function handleLogoUpload(event){const file=event.target.files[0],fileChosen=document.getElementById("fileChosen"),fileUploadLabel=document.querySelector(".file-upload-label");if(file){fileChosen.textContent=file.name,fileUploadLabel.textContent="Change File";const reader=new FileReader;reader.onload=function(e){const previewLogo=document.getElementById("previewLogo");previewLogo.src=e.target.result,previewLogo.style.display="block"},reader.readAsDataURL(file)}else{fileChosen.textContent="No file chosen",fileUploadLabel.textContent="Choose File";document.getElementById("previewLogo").style.display="none"}}function updatePreviewItems(){const previewItemsBody=document.getElementById("previewItemsBody"),itemRows=document.getElementById("itemsContainer").querySelectorAll(".item-row"),previewItemsSection=document.querySelector(".preview-items");previewItemsBody.innerHTML="";let hasValidItems=!1;itemRows.forEach(row=>{const name=row.querySelector(".item-name").value,quantity=parseFloat(row.querySelector(".item-quantity").value)||0,price=parseFloat(row.querySelector(".item-price").value)||0;if(name&&price>0){hasValidItems=!0;const total=quantity*price,tr=document.createElement("tr");tr.innerHTML=`\n                <td>${name}</td>\n                <td>${quantity}</td>\n                <td>${formatCurrency(price)}</td>\n                <td>${formatCurrency(total)}</td>\n            `,previewItemsBody.appendChild(tr)}}),previewItemsSection.style.display=hasValidItems?"block":"none"}function resetForm(){if(confirm("Are you sure you want to reset all content? This will clear all entered information.")){document.getElementById("invoiceForm").reset(),setDefaultDates();document.getElementById("itemsContainer").innerHTML='\n            <div class="item-row" data-index="0">\n                <input type="text" class="item-name" placeholder="Item description">\n                <input type="number" class="item-quantity" placeholder="Qty" min="1" value="1">\n                <input type="number" class="item-price" placeholder="Price" min="0" step="0.01">\n                <span class="item-total">0.00</span>\n                <button type="button" class="remove-item" disabled>Ã—</button>\n            </div>\n        ',updatePreview()}}function arePDFLibrariesLoaded(){return window.jspdf&&window.html2canvas}function loadPDFLibraries(){return new Promise((resolve,reject)=>{if(arePDFLibrariesLoaded())return void resolve();const scripts=["https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js","https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"];let loadedCount=0;scripts.forEach(src=>{const script=document.createElement("script");script.src=src,script.onload=()=>{loadedCount++,loadedCount===scripts.length&&resolve()},script.onerror=reject,document.head.appendChild(script)})})}function downloadPDF(){const downloadBtn=document.getElementById("downloadPDF"),originalText=downloadBtn.textContent;downloadBtn.textContent="Loading libraries...",downloadBtn.disabled=!0,loadPDFLibraries().then(()=>(downloadBtn.textContent="Generating PDF...",html2canvas(document.getElementById("invoicePreview"),{scale:2,useCORS:!0,logging:!1}))).then(canvas=>{const{jsPDF:jsPDF}=window.jspdf,pdf=new jsPDF("p","mm","a4"),imgData=canvas.toDataURL("image/png"),pdfWidth=pdf.internal.pageSize.getWidth(),pdfHeight=pdf.internal.pageSize.getHeight(),imgWidth=canvas.width,imgHeight=canvas.height,ratio=Math.min(pdfWidth/imgWidth,pdfHeight/imgHeight),imgX=(pdfWidth-imgWidth*ratio)/2;pdf.addImage(imgData,"PNG",imgX,10,imgWidth*ratio,imgHeight*ratio);const filename=`${document.getElementById("invoiceNumber").value||"invoice"}_${document.getElementById("buyerName").value||"client"}.pdf`.replace(/[^a-zA-Z0-9_-]/g,"_");pdf.save(filename),downloadBtn.textContent=originalText,downloadBtn.disabled=!1}).catch(error=>{console.error("PDF generation error:",error),alert("PDF generation failed. Please try again or check your browser support."),downloadBtn.textContent=originalText,downloadBtn.disabled=!1})}document.addEventListener("DOMContentLoaded",function(){initializeApp()}),document.addEventListener("keydown",function(e){e.ctrlKey&&"Enter"===e.key&&(e.preventDefault(),downloadPDF()),e.ctrlKey&&"n"===e.key&&(e.preventDefault(),addItemRow()),"Escape"===e.key&&(e.preventDefault(),resetForm())}),"serviceWorker"in navigator&&window.addEventListener("load",function(){navigator.serviceWorker.register("/sw.js").then(function(registration){console.log("ServiceWorker registration successful")},function(err){console.log("ServiceWorker registration failed: ",err)})});